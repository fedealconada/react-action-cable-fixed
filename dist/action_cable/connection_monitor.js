var ConnectionMonitor,INTERNAL,bind=function(t,n){return function(){return t.apply(n,arguments)}};INTERNAL=require("./internal"),ConnectionMonitor=function(){function t(t){this.consumer=t,this.visibilityDidChange=bind(this.visibilityDidChange,this),this.consumer.subscriptions.add(this),this.start()}var n,e,i;return t.pollInterval={min:3,max:30},t.staleThreshold=6,t.prototype.identifier=INTERNAL.identifiers.ping,t.prototype.connected=function(){return this.reset(),this.pingedAt=e(),delete this.disconnectedAt},t.prototype.disconnected=function(){return this.disconnectedAt=e()},t.prototype.received=function(){return this.pingedAt=e()},t.prototype.reset=function(){return this.reconnectAttempts=0},t.prototype.start=function(){return this.reset(),delete this.stoppedAt,this.startedAt=e(),this.poll(),document.addEventListener("visibilitychange",this.visibilityDidChange)},t.prototype.stop=function(){return this.stoppedAt=e(),document.removeEventListener("visibilitychange",this.visibilityDidChange)},t.prototype.poll=function(){return setTimeout(function(t){return function(){if(!t.stoppedAt)return t.reconnectIfStale(),t.poll()}}(this),this.getInterval())},t.prototype.getInterval=function(){var t,e,i,o;return o=this.constructor.pollInterval,i=o.min,e=o.max,t=5*Math.log(this.reconnectAttempts+1),1e3*n(t,i,e)},t.prototype.reconnectIfStale=function(){if(this.connectionIsStale()&&(this.reconnectAttempts++,!this.disconnectedRecently()))return this.consumer.connection.reopen()},t.prototype.connectionIsStale=function(){var t;return i(null!=(t=this.pingedAt)?t:this.startedAt)>this.constructor.staleThreshold},t.prototype.disconnectedRecently=function(){return this.disconnectedAt&&i(this.disconnectedAt)<this.constructor.staleThreshold},t.prototype.visibilityDidChange=function(){if("visible"===document.visibilityState)return setTimeout(function(t){return function(){if(t.connectionIsStale()||!t.consumer.connection.isOpen())return t.consumer.connection.reopen()}}(this),200)},t.prototype.toJSON=function(){var t,n;return n=this.getInterval(),t=this.connectionIsStale(),{startedAt:this.startedAt,stoppedAt:this.stoppedAt,pingedAt:this.pingedAt,reconnectAttempts:this.reconnectAttempts,connectionIsStale:t,interval:n}},e=function(){return(new Date).getTime()},i=function(t){return(e()-t)/1e3},n=function(t,n,e){return Math.max(n,Math.min(e,t))},t}(),module.exports=ConnectionMonitor;